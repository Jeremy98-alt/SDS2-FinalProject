---
title: "Guessing, if there is a Heart Attack or not"
subtitle: "Statistical Methods and Laboratory, Part II - The Final Project"
author: "Sapienza Jeremy 1960498"
date: "6/18/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)

require(tidyverse)
require(magrittr)
require(R2jags)
require(bayesplot)
require(TeachingDemos)
require(factoextra)
require(highcharter)
require(dplyr)

load_cat <- function(frame) {
    
  sorted_df <- frame %>%
              drop_na() %>%
              dplyr::summarise(Count = n()) %>%
              dplyr::arrange(desc(Count)) %>%
              dplyr::mutate(percentage = paste0(round(Count / sum(Count) * 100, 1), "%"))
    
    return(sorted_df)
}

hist.and.summary <- function(variable, main.title){
  print(summary(dat[[variable]])) 
  hchart(dat[[variable]], type = "column", name = variable, color = randomcoloR::randomColor()) %>%
    hc_title(text = main.title) %>%
    hc_xAxis(title = variable) %>%
    hc_chart(options3d=list(enabled=TRUE, alpha=2, beta=-10, 
                              depth=100, viewDistance=25)) %>% 
    hc_plotOptions(column=list(depth= 100))
}

dense.chart <- function(name, title){ # Showing the density considering the two cases of having an heart attack or not
  
  frame <- dat[ , (names(dat) %in% c(name, 'output'))] # select the interested rows

  # sub select the two categories
  normal <- frame %>% filter(output == 0)
  heart_attack <- frame %>% filter(output == 1)

  hchart( density(unlist(normal[, name])), type = "area", color = randomcoloR::randomColor(), name = "Normal") %>%
      hc_add_series( density(unlist(heart_attack[, name])), type = "area", color = randomcoloR::randomColor(), name = "Heart Attack") %>%
        hc_title(text= title) %>%
          hc_xAxis(title = name)
}
```

$$~$$

<center>![](./img/heart_structure_wfunction.jpg)</center>

$$~$$

# Introduction

$$~$$

Nowadays, with the improvement of the technologies there are an amount of data that allows us to understand if there is any problem or not in the healthy of a person.

Here in this project we explain and we try to predict whether a patient should be diagnosed with Heart Disease or not.

$$~$$

## The Dataset

$$~$$

<center>![](./img/kaggle.png){width=40%}</center>

$$~$$

Kaggle, is the main platform where I found this interesting dataset where applying our main bayesian inference for the main scope of this project.

This dataset is composed by these features:

```{r echo=FALSE, warning=FALSE}
dat <- read_csv("heart.csv")
dat <- unique(dat) # remove any duplicate presents
head(dat)
```

$$~$$

Analyzing these features, I recognized that the:

<style>
ol ul {
    margin-bottom: 10px;
}
</style>

1. ***Age*** -> it refers to the age of the patient
2. ***sex*** -> it refers if the patient is:
    + male (1)
    + female (0)
3. ***cp*** -> it refers to the chest pain type that could be of four types:
    + 0 is the typical angina
    + 1 is the atypical angina
    + 2 is the non-anginal pain
    + 3 is the asymptomatic type
4. ***trestbps*** -> it refers to the resting blood pressure
5. ***chol*** -> it refers to the serum cholesterol in mg/dl
6. ***fbs*** -> it refers to the fasting blood sugar that if it is larger than 120 mg/dl is represented with:
    + 1 (true)
    + 0 (false)
7. ***restecg*** -> it refers to the resting electrocardiographic results: 
    + 0 as Normal
    + 1 having ST-T wave abnormality (T wave inversions and/or ST elevation or depression of > 0.05 mV)
    + 2) showing probable or definite left ventricular hypertrophy by Estes' criteria
8. ***thalachh*** -> it refers to the maximum heart rate achieved
9. ***exng*** -> it refers to the exercise induced angina that could be:
    + 1 (yes)
    + 0 (no)
10. ***oldpeak*** -> it refers to the Previous peak
11. ***slp*** -> it refers to the peak exercise ST segment: 
    + 0 as up sloping
    + 1 as flat
    + 2 as down sloping
12. ***caa*** -> it refers to the number of major vessels that goes from 0 to 3
13. ***thall*** -> it refers to the maximum heart rate achieved: 
    + 0 as no-data 
    + 1 as normal
    + 2 as fixed defect
    + 3 as reversible defect
14. ***output*** -> it refers to the fact to have the heart attack or not

$$~$$

The main features detected are for each feature: 

$$~$$

```{r echo=FALSE}
summary(dat)
```

$$~$$

## The Data Visualization

$$~$$

In this subsection we want to describe graphically the dataset that we are analyzing to have a first taste of what is the better model to use in this case, we want to show below some interesting plots

$$~$$

### The visualization using PCA

$$~$$

PCA is a particular tool that allows us to show the behaviour of the patients (treated as points in this space) of our data. We see in this way which are the patients more similar to each other

$$~$$

```{r echo=FALSE, fig.align="center"}
# for visualization
res.pca <- prcomp(dat, scale = FALSE) # compute PCA

# patients  with a similar profile are grouped together
fviz_pca_ind(res.pca,
             col.ind = "cos2", # Color by the quality of representation
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel =FALSE,     # Avoid text overlapping
             label=FALSE
)

fviz_eig(res.pca) # Show the percentage of variances explained by each principal component
```

$$~$$

Its normal to denote that there could be some losses on this representation due to the amount of features that we want to consider. 

$$~$$

## The Categorical Data

$$~$$

Here, we want to analyze the percentages of the categorical data:

$$~$$

```{r echo=FALSE}
get_cp_str <- function(bool_var){
  char_list <- c(1, length(bool_var))
  for (i in 1:length(bool_var)) {
    var <- bool_var[i]
    new_char <- 'unknown'  
    
    if(var == 0){
        new_char <- 'typical angina'
    }
      
    if(var == 1){
        new_char <- 'atypical angina'
    }
      
    if(var == 2){
        new_char <- 'non-anginal pain'
    }
      
    if(var == 3){
        new_char <- 'asymptomatic'
    }
      
     char_list[i] <-  new_char
   }
    
    return(char_list)
 }

cp_dat <- dat %>% 
    dplyr::select(cp) %>%
    dplyr::group_by(cp) %>%
    dplyr::summarise(Count = n()) %>%
    dplyr::arrange(desc(Count)) %>%
    dplyr::mutate(
        cp_str = get_cp_str(cp),
        percentage = paste0(round(Count / sum(Count) * 100, 1), "%")
    )

cp_dat %>%
  hchart(type = "pie", hcaes(x = paste(cp_str, ' \t(', percentage, ')' ), y = Count)) %>%
    hc_xAxis(title = 'Chest Pain', categories = paste(cp_dat$cp_str, ' (', cp_dat$percentage, ')' )) %>%
    hc_title(text = 'Chest Pain') %>%
    hc_add_theme(hc_theme_google()) %>%
    hc_chart(options3d=list(enabled=TRUE, alpha=45, beta=0)) %>% 
    hc_plotOptions(pie=list(innerSize= 100, 
                            depth= 45))
```

```{r echo=FALSE}
get_string <- function(bool_var){
  char_list <- c(1, length(bool_var))
  for (i in 1:length(bool_var)) {
    var <- bool_var[i]
    new_char <- 'unknown'  
    
    if(var == 1){
        new_char <- 'prediabetes (fbs > 120 mg/d)'
    }
    else{
        new_char <- 'normal'
     }
      
     char_list[i] <-  new_char
   }
    
    return(char_list)
 }

fbs_dat <- dat %>% 
    dplyr::select(fbs) %>%
    dplyr::group_by(fbs) %>%
    dplyr::summarise(Count = n()) %>%
    dplyr::arrange(desc(Count)) %>%
    dplyr::mutate(
        fbs_str = get_string(fbs),
        percentage = paste0(round(Count / sum(Count) * 100, 1), "%")
    )

fbs_dat %>%
  hchart(type = "pie", hcaes(x = paste(fbs_str, ' \t(', percentage, ')' ), y = Count)) %>%
    hc_xAxis(title = 'fasting blood sugar', categories = paste(get_string(fbs_dat$fbs_str), ' (', fbs_dat$percentage, ')' )) %>%
    hc_title(text = 'Fasting Blood Sugar') %>%
    hc_add_theme(hc_theme_google()) %>%
    hc_chart(options3d=list(enabled=TRUE, alpha=45)) %>% 
    hc_plotOptions(pie=list(innerSize= 100, 
                            depth= 45))
```

```{r echo=FALSE}
get_restecg_str <- function(bool_var){
  char_list <- c(1, length(bool_var))
  for (i in 1:length(bool_var)) {
    var <- bool_var[i]
    new_char <- 'unknown'  
    
    if(var == 0){
        new_char <- 'Normal'
    }
    if(var == 1){
        new_char <- 'lvl 1, having ST-T wave abnormality (T wave inversions and/or ST elevation or depression of > 0.05 mV)'
    }
    if(var == 2){
        new_char <- "lvl 2, showing probable or definite left ventricular hypertrophy by Estes' criteria"
     }
      
     char_list[i] <-  new_char
   }
    
    return(char_list)
 }

restecg_dat <- dat %>% 
    dplyr::select(restecg) %>%
    dplyr::group_by(restecg) %>%
    dplyr::summarise(Count = n()) %>%
    dplyr::arrange(desc(Count)) %>%
    dplyr::mutate(
        restecg_str = get_restecg_str(restecg),
        percentage = paste0(round(Count / sum(Count) * 100, 1), "%")
    )

restecg_dat %>%
  hchart(type = "pie", hcaes(x = paste(restecg_str, ' \t(', percentage, ')' ), y = Count)) %>%
    hc_xAxis(title = 'restecg', categories = paste(restecg_dat$restecg_str, ' (', restecg_dat$percentage, ')' )) %>%
    hc_title(text = 'Resting Electrocardiographic Results') %>%
    hc_add_theme(hc_theme_google()) %>%
    hc_chart(options3d=list(enabled=TRUE, alpha=45)) %>% 
    hc_plotOptions(pie=list(innerSize= 100, 
                            depth= 45))
```

```{r echo=FALSE}
slp_dat <- load_cat(
              dat %>%
               dplyr::select(slp) %>%
               dplyr::group_by(slp)
             )

slp_dat %>%
  hchart(type = "pie", hcaes(x = paste(slp, ' \t(', percentage, ')' ), y = Count)) %>%
    hc_xAxis(title = 'Slope', categories = paste(slp_dat$slp, ' (', slp_dat$percentage, ')' )) %>%
    hc_title(text = 'Slope') %>%
    hc_add_theme(hc_theme_google()) %>%
    hc_chart(options3d=list(enabled=TRUE, alpha=45)) %>% 
    hc_plotOptions(pie=list(innerSize= 100, 
                            depth= 45))
    
```

```{r echo=FALSE}
caa_dat <- load_cat(
              dat %>%
               dplyr::select(caa) %>%
               dplyr::group_by(caa)
             )

caa_dat %>%
  hchart(type = "pie", hcaes(x = paste(caa, ' \t(', percentage, ')' ), y = Count)) %>%
    hc_xAxis(title = 'caa', categories = paste(caa_dat$caa, ' (', caa_dat$percentage, ')' )) %>%
    hc_title(text = 'Number of Major Vessels (0-4)') %>%
    hc_add_theme(hc_theme_google()) %>%
    hc_chart(options3d=list(enabled=TRUE, alpha=45)) %>% 
    hc_plotOptions(pie=list(innerSize= 100, 
                            depth= 45))

```

```{r echo=FALSE}

thall_dat <- load_cat(
              dat %>%
               dplyr::select(thall) %>%
               dplyr::group_by(thall)
             )

thall_dat %>%
  hchart(type = "pie", hcaes(x = paste(thall, ' \t(', percentage, ')' ), y = Count)) %>%
    hc_xAxis(title = 'Thall', categories = paste(thall_dat$thall, ' (', thall_dat$percentage, ')' )) %>%
    hc_title(text = 'Thall') %>%
    hc_add_theme(hc_theme_google()) %>%
    hc_chart(options3d=list(enabled=TRUE, alpha=45)) %>% 
    hc_plotOptions(pie=list(innerSize= 100, 
                            depth= 45))

```

```{r echo=FALSE}
make_string <- function(bool_var){
  char_list <- c(1, length(bool_var))
  for (i in 1:length(bool_var)) {
    var <- bool_var[i]
    new_char <- 'unknown'  
    
    if(var == 1){
        new_char <- 'Yes'
    }
    else{
        new_char <- 'No'
     }
      
     char_list[i] <-  new_char
   }
    
    return(char_list)
 }

exng_dat <- dat %>% 
    dplyr::select(exng) %>%
    dplyr::group_by(exng) %>%
    dplyr::summarise(Count = n()) %>%
    dplyr::arrange(desc(Count)) %>%
    dplyr::mutate(
        exng_txt = make_string(exng),
        percentage = paste0(round(Count / sum(Count) * 100, 1), "%")
    )
exng_dat %>%
  hchart(type = "pie", hcaes(x = paste(exng_txt, ' \t(', percentage, ')' ), y = Count)) %>%
    hc_xAxis(title = 'Exercise Induced Angina', categories = paste(exng_dat$exng_txt, ' (', exng_dat$percentage, ')' )) %>%
    hc_title(text = 'Exercise Induced Angina (1 = yes; 0 = no)') %>%
    hc_add_theme(hc_theme_google()) %>%
    hc_chart(options3d=list(enabled=TRUE, alpha=45)) %>% 
    hc_plotOptions(pie=list(innerSize= 100, 
                            depth= 45))

```

```{r echo=FALSE}

make_string = function(bool_var){
  char_list = c(1, length(bool_var))
  for (i in 1:length(bool_var)) {
    var = bool_var[i]
    new_char = 'unknown'  
    
    if(var == 1){
        new_char = 'Male'
    }
    else{
        new_char = 'Female'
     }
      
     char_list[i] =  new_char
   }
    
    return(char_list)
 }

gender_dat <- dat %>% 
    dplyr::select(sex) %>%
    dplyr::group_by(sex) %>%
    dplyr::summarise(Count = n()) %>%
    dplyr::arrange(desc(Count)) %>%
    dplyr::mutate(
        gender = make_string(sex),
        percentage = paste0(round(Count / sum(Count) * 100, 1), "%")
    )


gender_dat %>%
  hchart(type = "pie", hcaes(x = paste(gender, ' \t(', percentage, ')' ), y = Count)) %>%
    hc_xAxis(categories = paste(gender_dat$gender, ' (', gender_dat$percentage, ')' )) %>%
    hc_title(text = "Person's Gender") %>%
    hc_add_theme(hc_theme_google()) %>%
    hc_chart(options3d=list(enabled=TRUE, alpha=45)) %>% 
    hc_plotOptions(pie=list(innerSize= 100, 
                            depth= 45))
              
``` 

```{r echo=FALSE}
make_string_heart <- function(bool_var){
  char_list <- c(1, length(bool_var))
  for (i in 1:length(bool_var)) {
    var <- bool_var[i]
    new_char <- 'unknown'  

    if(var == 0){
        new_char <- '0 - Normal'
     }
      
    if(var == 1){
        new_char <- '1 - Heart Attack'
    }
      
     char_list[i] <-  new_char
   }
    
    return(char_list)
 }

output_dat <- dat %>% 
    dplyr::select(output) %>%
    dplyr::group_by(output) %>%
    dplyr::summarise(Count = n()) %>%
    dplyr::arrange(desc(Count)) %>%
    dplyr::mutate(
        heart_attack = make_string_heart(output),
        percentage = paste0(round(Count / sum(Count) * 100, 1), "%")
    )


output_dat %>%
  hchart(type = "pie", hcaes(x = paste(heart_attack, ' \t(', percentage, ')' ), y = Count)) %>%
    hc_xAxis(categories = paste(output_dat$heart_attack, ' (', gender_dat$percentage, ')' )) %>%
    hc_title(text = 'Heart Attack') %>%
    hc_add_theme(hc_theme_google())  %>%
    hc_chart(options3d=list(enabled=TRUE, alpha=45)) %>% 
    hc_plotOptions(pie=list(innerSize= 100, 
                            depth= 45))         

```

$$~$$

## The Quantitative Data

$$~$$

We illustrate the main features of the quantitative data, after have seen the categorical data in the previous section:

$$~$$

```{r, fig.width = 8, fig.height = 6}
hist.and.summary('age', 'Persons Age')
hist.and.summary('chol', 'Cholestoral')
hist.and.summary('thalachh', 'Maximum Heart Rate Achieved')
hist.and.summary('trtbps', 'Resting Blood Pressure')
hist.and.summary('oldpeak', 'Previous Peak')
```

$$~$$

After this, we consider also the densities considering the case of having the heart attack and not:

$$~$$

```{r}
dense.chart('age', 'Persons Age')
dense.chart('chol', 'Cholestoral')
dense.chart('thalachh', 'Maximum Heart Rate Achieved')
dense.chart('trtbps', 'Resting Blood Pressure')
dense.chart('oldpeak', 'Previous Peak')
```


## The Correlations

$$~$$

Here, we want to highlight the correlations between the features treated in qualitative, quantitative and without any distinction.

$$~$$

```{r echo=FALSE}
hchart(cor(dat[, c("sex", "cp", "fbs", "restecg", "exng", "slp", "caa", "thall")]), color = randomcoloR::randomColor()) %>%
  hc_title(text = "Correlations between qualitative variables") # considering only the qualitative data

hchart(cor(dat[, c("age", "chol", "thalachh", "trtbps", "oldpeak")]), color = randomcoloR::randomColor()) %>%
  hc_title(text = "Correlations between quantitative variables") # considering only the quantitative data

hchart(cor(dat[, c(1:13)]), color = randomcoloR::randomColor()) %>%
  hc_title(text = "Correlations between all independent variables") # considering only the whole data
```

# The Goal

$$~$$

The main goal is to leverage the main fully Bayesian analysis on our data, based on understanding if a person has a heart attack or not. So, the response variable $Y_i$ (that is the "output" feature in our dataset) is the heart attack $\in \{0,1\}$ and the predictor variables ($x_i \in \mathbb{R}^{+}$) have been chosen using the glm() function, used to fit generalized linear models, specified by giving a symbolic description of the linear predictor and a description of the error distribution, as we can see below:

```{r echo=FALSE}
# Preparing data for JAGS
N <- nrow(dat) # number of obs

# Dependent Variable
y <- as.vector(dat$output) # Target variable, risks heart attack?

# Independent Variables
x1 <- as.vector(dat$age) # Age
x2 <- as.vector(dat$sex) # Sex
x3 <- as.vector(dat$cp) # Chest Pain Type: 1) Typical Angina 2) Atypical Angina 3) Non-Anginal Pain 4) Asymptomatic
x4 <- as.vector(dat$trtbps) # resting blood pressure (in mm Hg)
x5 <- as.vector(dat$chol) # cholestoral in mg/dl fetched via BMI sensor
x6 <- as.vector(dat$fbs) # (fasting blood sugar > 120 mg/dl) (1 = true; 0 = false)
x7 <- as.vector(dat$restecg) # resting electrocardiographic results 0) Normal 1) having ST-T wave abnormality (T wave inversions and/or ST elevation or depression of > 0.05 mV) 2) showing probable or definite left ventricular hypertrophy by Estes' criteria 
x8 <- as.vector(dat$thalachh) # maximum heart rate achieved
x9 <- as.vector(dat$exng) # exercise induced angina (1 = yes; 0 = no)
x10 <- as.vector(dat$oldpeak) # Previous peak
x11 <- as.vector(dat$slp) # Slope
x12 <- as.vector(dat$caa) # number of major vessels (0-3)
x13 <- as.vector(dat$thall) # Thal rate

summary(glm(y ~ x1+x2+x3+x4+x5+x6+x7+x8+x9+x10+x11+x12+x13, family = binomial(),data=dat))
```

$$~$$

As we can see above, the glm rejects the hypothesis to consider the variables:

- ***Age***
- ***Cholestoral***
- ***fasting blood sugar***
- ***resting electrocardiographic results***

... and also the intercept isn't a good choice to admit in our model.

then, in summary we have N = 302 observations. Then we decided to consider to models to see the difference on which model choice at the end of our analysis.

$$~$$

# The First Model

$$~$$
We decide to consider the following logistic regression model with the logit link function: 

$$
Y_i \sim Bern(p_i) \\
logit(p_i) = \beta_{2} \cdot x_{2_i} + \beta_{3} \cdot x_{3_i} + \beta_{4} \cdot x_{4_i} +\beta_{8} \cdot x_{8_i} + \beta_{9} \cdot x_{9_i} + \beta_{10} \cdot x_{10_i} + \beta_{11} \cdot x_{11_i} + \beta_{12} \cdot x_{12_i} + \beta_{13} \cdot x_{13_i}
$$
The prior beta parameters are chosen approximatly considering the estimated averages saw in the previous subsection regarding the outcomes of glm(). So, the beta prior parameters are distributed following a normal distribution as follows:

$$
\beta_2 \sim N(\mu_2 = -1, \tau^{2} = 1.0 \cdot 10^{-6}) \\
\beta_3 \sim N(\mu_3 = 0.5, \tau^{2} = 1.0 \cdot 10^{-6}) \\
\beta_4 \sim N(\mu_4 = 0, \tau^{2} = 1.0 \cdot 10^{-6}) \\
\beta_8 \sim N(\mu_8 = 0, \tau^{2} = 1.0 \cdot 10^{-6}) \\
\beta_9 \sim N(\mu_9 = -0.5, \tau^{2} = 1.0 \cdot 10^{-6}) \\
\beta_{10} \sim N(\mu_{10} = 0.5, \tau^{2} = 1.0 \cdot 10^{-6}) \\
\beta_{11} \sim N(\mu_{11} = 0.5, \tau^{2} = 1.0 \cdot 10^{-6}) \\
\beta_{12} \sim N(\mu_{12} = -0.5, \tau^{2} = 1.0 \cdot 10^{-6}) \\
\beta_{13} \sim N(\mu_{13} = -0.5, \tau^{2} = 1.0 \cdot 10^{-6}) \\
$$
The main reason is that we prefer chosing the binary classification as in this case the logistic regression to model our outcomes based only on 0 or 1.

$$~$$

### The Cumulative Means

$$~$$

### The Approximation Errors

$$~$$

### The Predictions

$$~$$

### The Correlations

$$~$$

# The Second Model

$$~$$

### The Cumulative Means

$$~$$

### The Approximation Errors

$$~$$

### The Predictions

$$~$$

### The Correlations

$$~$$

# The comparison between these two models

$$~$$

# The Conclusions

$$~$$

$$~$$

# The References

$$~$$